# Generated by CogSol 0.2.0 on 2026-02-13 18:39
from cogsol.db import migrations


class Migration(migrations.Migration):
    initial = True
    dependencies = []
    operations = [
        migrations.CreateTool(name='GetUserContext', fields={'name': 'get_user_context', 'description': 'Reads user_id from the latest user message metadata and returns the user profile for personalization.', 'show_tool_message': False, 'parameters': {}, '__code__': 'def run(self, chat=None, data=None, secrets=None, log=None):\n    import json\n\n    log.append("Reading metadata from latest user message")\n\n    # Hardcoded user profiles. In production, replace this with a call\n    # to your user database, CRM, or identity provider.\n    USERS = {\n        "USR-001": {\n            "name": "Maria Garcia",\n            "language": "es",\n            "role": "developer",\n            "plan": "Enterprise",\n            "projects": ["API Gateway v2", "Auth Service"],\n            "open_tickets": 2,\n            "last_deploy": "2026-02-12",\n            "api_usage": "12,450 / 50,000 calls this month",\n        },\n        "USR-002": {\n            "name": "John Smith",\n            "language": "en",\n            "role": "manager",\n            "plan": "Enterprise",\n            "team_members": 8,\n            "active_projects": 3,\n            "monthly_budget_used": "72%",\n            "next_review": "2026-03-01",\n        },\n        "USR-003": {\n            "name": "Ana Silva",\n            "language": "pt",\n            "role": "analyst",\n            "plan": "Professional",\n            "dashboards": ["Usage Trends", "Error Rates", "Cost Analysis"],\n            "reports_generated": 14,\n            "data_sources_connected": 5,\n            "last_export": "2026-02-10",\n        },\n    }\n\n    LANGUAGE_NAMES = {"es": "Spanish", "en": "English", "pt": "Portuguese"}\n\n    ROLE_STYLES = {\n        "developer": "technical and detailed",\n        "manager": "executive summary, high-level",\n        "analyst": "data-oriented and precise",\n    }\n\n    # --- Read metadata from user messages (scan backwards) ---\n    # The frontend may only attach metadata on the first message.\n    # Scan from newest to oldest to find the most recent user_id.\n    user_messages = chat.messages.filter(role="user").order_by("-msg_num")\n\n    if not user_messages.exists():\n        log.append("No user messages found")\n        data["prompt_params"]["context"]["User context"] = (\n            "No user identified. Respond in English with a general tone."\n        )\n        return\n\n    user_id = None\n    for msg in user_messages:\n        metadata = getattr(msg, "metadata", None)\n        if not metadata:\n            continue\n\n        if isinstance(metadata, dict):\n            user_id = metadata.get("user_id")\n        elif isinstance(metadata, str):\n            try:\n                parsed = json.loads(metadata)\n                if isinstance(parsed, dict):\n                    user_id = parsed.get("user_id")\n            except (json.JSONDecodeError, TypeError):\n                pass\n\n        # Platform UI stores values as lists: {"user_id": ["USR-001"]}\n        if isinstance(user_id, list):\n            user_id = user_id[0] if user_id else None\n\n        if user_id:\n            log.append(f"Found user_id={user_id} in message #{msg.msg_num}")\n            break\n\n    if not user_id:\n        log.append("No user_id found in any message metadata")\n        data["prompt_params"]["context"]["User context"] = (\n            "No user metadata provided. Respond in English with a general tone."\n        )\n        return\n\n    # --- Look up user profile ---\n    user = USERS.get(user_id)\n\n    if not user:\n        log.append(f"Unknown user_id: {user_id}")\n        data["prompt_params"]["context"]["User context"] = (\n            f"Unknown user_id: {user_id}. Respond in English with a general tone."\n        )\n        return\n\n    language_name = LANGUAGE_NAMES.get(user["language"], "English")\n    role_style = ROLE_STYLES.get(user["role"], "general")\n\n    # Build profile summary\n    profile_lines = [\n        f"Name: {user[\'name\']} (ID: {user_id})",\n        f"Language: {language_name}",\n        f"Role: {user[\'role\']}",\n        f"Plan: {user.get(\'plan\', \'N/A\')}",\n    ]\n\n    # Add role-specific account details\n    if user["role"] == "developer":\n        profile_lines.append(f"Projects: {\', \'.join(user.get(\'projects\', []))}")\n        profile_lines.append(f"Open tickets: {user.get(\'open_tickets\', 0)}")\n        profile_lines.append(f"Last deploy: {user.get(\'last_deploy\', \'N/A\')}")\n        profile_lines.append(f"API usage: {user.get(\'api_usage\', \'N/A\')}")\n    elif user["role"] == "manager":\n        profile_lines.append(f"Team members: {user.get(\'team_members\', 0)}")\n        profile_lines.append(f"Active projects: {user.get(\'active_projects\', 0)}")\n        profile_lines.append(f"Monthly budget used: {user.get(\'monthly_budget_used\', \'N/A\')}")\n        profile_lines.append(f"Next review: {user.get(\'next_review\', \'N/A\')}")\n    elif user["role"] == "analyst":\n        profile_lines.append(f"Dashboards: {\', \'.join(user.get(\'dashboards\', []))}")\n        profile_lines.append(f"Reports generated: {user.get(\'reports_generated\', 0)}")\n        profile_lines.append(f"Data sources connected: {user.get(\'data_sources_connected\', 0)}")\n        profile_lines.append(f"Last export: {user.get(\'last_export\', \'N/A\')}")\n\n    profile_summary = "; ".join(profile_lines)\n\n    context = (\n        f"{profile_summary}. "\n        f"Respond in {language_name}, address the user by name, "\n        f"and use a {role_style} communication style."\n    )\n\n    data["prompt_params"]["context"]["User context"] = context\n    log.append(f"User context resolved: {user[\'name\']} ({user[\'role\']}, {user[\'language\']})")'}),
        migrations.CreateAgent(name='MessageMetadataAgent', fields={'system_prompt': '# Message Metadata Assistant\n\nYou are a support assistant that personalizes responses based on user context. When user context is available, follow its instructions for language, name, and communication style.', 'generation_config': 'QA', 'pregeneration_config': 'QA', 'temperature': 0.3, 'max_responses': 10, 'max_msg_length': 2048, 'max_consecutive_tool_calls': 3, 'pretools': ['get_user_context'], 'initial_message': 'Hello! I am the Message Metadata Assistant. I personalize my responses based on user metadata attached to messages. To try it out, tap the {} button next to the message input, add a metadata entry with key user_id and one of these values: USR-001 (Maria, Spanish, developer), USR-002 (John, English, manager), or USR-003 (Ana, Portuguese, analyst). Then send any message and see how I adapt!', 'forced_termination_message': 'Thank you for using the Message Metadata Assistant. Visit https://docs.cogsol.ai for the full reference.', 'no_information_message': "I don't have specific information about that topic. Please check the official documentation at https://docs.cogsol.ai.", 'name': 'MessageMetadata'}, meta={'name': 'MessageMetadataAgent', 'chat_name': 'Message Metadata Assistant'}),
    ]
